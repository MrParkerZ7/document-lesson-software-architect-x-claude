<mxfile host="app.diagrams.net" modified="2024-01-15T10:00:00.000Z" agent="Claude" version="21.0.0">
  <diagram name="Compensating Transactions" id="compensating-transactions">
    <mxGraphModel dx="1400" dy="900" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="1400" pageHeight="900" math="0" shadow="0">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />

        <!-- Title -->
        <mxCell id="title" value="Compensating Transactions" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;fontSize=24;fontStyle=1;fontColor=#1a1a2e;" vertex="1" parent="1">
          <mxGeometry x="480" y="20" width="440" height="40" as="geometry" />
        </mxCell>

        <mxCell id="subtitle" value="Undoing committed transactions in distributed systems" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;fontSize=14;fontColor=#666666;" vertex="1" parent="1">
          <mxGeometry x="460" y="55" width="480" height="25" as="geometry" />
        </mxCell>

        <!-- Concept Explanation -->
        <mxCell id="concept-box" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;strokeWidth=2;" vertex="1" parent="1">
          <mxGeometry x="40" y="90" width="500" height="140" as="geometry" />
        </mxCell>

        <mxCell id="concept-title" value="What are Compensating Transactions?" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;fontSize=14;fontStyle=1;fontColor=#1a1a2e;" vertex="1" parent="1">
          <mxGeometry x="140" y="100" width="300" height="25" as="geometry" />
        </mxCell>

        <mxCell id="concept-text" value="In distributed systems, traditional ACID rollback isn't possible across&#xa;service boundaries. Compensating transactions are semantic operations&#xa;that undo the effects of a previous operation.&#xa;&#xa;Key Principle: Each forward action needs a corresponding reverse action&#xa;that brings the system to an equivalent (not identical) state." style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=top;fontSize=11;fontColor=#333333;spacingLeft=10;" vertex="1" parent="1">
          <mxGeometry x="50" y="125" width="480" height="95" as="geometry" />
        </mxCell>

        <!-- Forward vs Compensation -->
        <mxCell id="forward-box" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;strokeWidth=2;" vertex="1" parent="1">
          <mxGeometry x="560" y="90" width="400" height="140" as="geometry" />
        </mxCell>

        <mxCell id="forward-title" value="Forward Action → Compensation" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;fontSize=14;fontStyle=1;fontColor=#1a1a2e;" vertex="1" parent="1">
          <mxGeometry x="640" y="100" width="240" height="25" as="geometry" />
        </mxCell>

        <mxCell id="forward-examples" value="createOrder()        →  cancelOrder()&#xa;processPayment()     →  refundPayment()&#xa;reserveInventory()   →  releaseInventory()&#xa;createShipment()     →  cancelShipment()&#xa;sendEmail()          →  sendCancellationEmail()&#xa;debitAccount()       →  creditAccount()" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=top;fontSize=11;fontColor=#333333;fontFamily=Courier New;spacingLeft=10;" vertex="1" parent="1">
          <mxGeometry x="580" y="130" width="360" height="90" as="geometry" />
        </mxCell>

        <!-- Timeline Visualization -->
        <mxCell id="timeline-title" value="Saga Execution Timeline with Compensation" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;fontSize=16;fontStyle=1;fontColor=#1a1a2e;" vertex="1" parent="1">
          <mxGeometry x="450" y="250" width="500" height="30" as="geometry" />
        </mxCell>

        <mxCell id="timeline-box" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#666666;strokeWidth=2;" vertex="1" parent="1">
          <mxGeometry x="40" y="290" width="1320" height="220" as="geometry" />
        </mxCell>

        <!-- Timeline axis -->
        <mxCell id="time-arrow" value="" style="endArrow=classic;html=1;strokeWidth=2;strokeColor=#666666;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="60" y="480" as="sourcePoint" />
            <mxPoint x="1340" y="480" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="time-label" value="Time →" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;fontSize=12;fontStyle=2;fontColor=#666666;" vertex="1" parent="1">
          <mxGeometry x="1280" y="460" width="60" height="20" as="geometry" />
        </mxCell>

        <!-- Forward transactions (T1-T4) -->
        <mxCell id="t1" value="T1&#xa;Create Order" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;fontSize=10;fontStyle=1;" vertex="1" parent="1">
          <mxGeometry x="80" y="330" width="90" height="50" as="geometry" />
        </mxCell>

        <mxCell id="t2" value="T2&#xa;Process Payment" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=10;fontStyle=1;" vertex="1" parent="1">
          <mxGeometry x="220" y="330" width="110" height="50" as="geometry" />
        </mxCell>

        <mxCell id="t3" value="T3&#xa;Reserve Inventory" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffe6cc;strokeColor=#d79b00;fontSize=10;fontStyle=1;" vertex="1" parent="1">
          <mxGeometry x="380" y="330" width="110" height="50" as="geometry" />
        </mxCell>

        <mxCell id="t4-fail" value="T4 FAILS&#xa;Create Shipment" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;fontSize=10;fontStyle=1;" vertex="1" parent="1">
          <mxGeometry x="540" y="330" width="110" height="50" as="geometry" />
        </mxCell>

        <!-- Failure point -->
        <mxCell id="fail-icon" value="✗" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;fontSize=24;fontStyle=1;fontColor=#b85450;" vertex="1" parent="1">
          <mxGeometry x="580" y="300" width="30" height="30" as="geometry" />
        </mxCell>

        <!-- Compensation transactions (C3, C2, C1) -->
        <mxCell id="c3" value="C3&#xa;Release Inventory" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;fontSize=10;fontStyle=1;" vertex="1" parent="1">
          <mxGeometry x="720" y="400" width="110" height="50" as="geometry" />
        </mxCell>

        <mxCell id="c2" value="C2&#xa;Refund Payment" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;fontSize=10;fontStyle=1;" vertex="1" parent="1">
          <mxGeometry x="890" y="400" width="110" height="50" as="geometry" />
        </mxCell>

        <mxCell id="c1" value="C1&#xa;Cancel Order" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;fontSize=10;fontStyle=1;" vertex="1" parent="1">
          <mxGeometry x="1060" y="400" width="100" height="50" as="geometry" />
        </mxCell>

        <mxCell id="end-state" value="Saga&#xa;Completed&#xa;(Compensated)" style="ellipse;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;fontSize=9;fontStyle=1;" vertex="1" parent="1">
          <mxGeometry x="1220" y="395" width="90" height="60" as="geometry" />
        </mxCell>

        <!-- Arrows -->
        <mxCell id="arr-t1-t2" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeColor=#82b366;strokeWidth=2;endArrow=classic;" edge="1" parent="1" source="t1" target="t2">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="arr-t2-t3" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeColor=#82b366;strokeWidth=2;endArrow=classic;" edge="1" parent="1" source="t2" target="t3">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="arr-t3-t4" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeColor=#82b366;strokeWidth=2;endArrow=classic;" edge="1" parent="1" source="t3" target="t4-fail">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="arr-t4-c3" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeColor=#b85450;strokeWidth=2;endArrow=classic;" edge="1" parent="1" source="t4-fail" target="c3">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="670" y="355" />
              <mxPoint x="670" y="425" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="arr-c3-c2" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeColor=#b85450;strokeWidth=2;endArrow=classic;" edge="1" parent="1" source="c3" target="c2">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="arr-c2-c1" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeColor=#b85450;strokeWidth=2;endArrow=classic;" edge="1" parent="1" source="c2" target="c1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="arr-c1-end" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeColor=#d6b656;strokeWidth=2;endArrow=classic;" edge="1" parent="1" source="c1" target="end-state">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <!-- Labels -->
        <mxCell id="forward-label" value="Forward Path (Success)" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;fontSize=11;fontStyle=1;fontColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="80" y="305" width="150" height="20" as="geometry" />
        </mxCell>
        <mxCell id="comp-label" value="Compensation Path (Rollback)" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;fontSize=11;fontStyle=1;fontColor=#b85450;" vertex="1" parent="1">
          <mxGeometry x="720" y="385" width="200" height="15" as="geometry" />
        </mxCell>

        <!-- Compensation Patterns -->
        <mxCell id="patterns-title" value="Compensation Patterns &amp; Strategies" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;fontSize=16;fontStyle=1;fontColor=#1a1a2e;" vertex="1" parent="1">
          <mxGeometry x="500" y="530" width="400" height="30" as="geometry" />
        </mxCell>

        <!-- Semantic Compensation -->
        <mxCell id="semantic-box" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;strokeWidth=2;" vertex="1" parent="1">
          <mxGeometry x="40" y="570" width="320" height="160" as="geometry" />
        </mxCell>

        <mxCell id="semantic-title" value="Semantic Compensation" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;fontSize=13;fontStyle=1;fontColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="110" y="580" width="180" height="25" as="geometry" />
        </mxCell>

        <mxCell id="semantic-text" value="• Undo the business effect, not the data&#xa;• May create new records (refund, credit)&#xa;• State after compensation ≈ initial state&#xa;• Example: Payment refund creates a new&#xa;  credit transaction, doesn't delete original" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=top;fontSize=10;fontColor=#333333;spacingLeft=10;" vertex="1" parent="1">
          <mxGeometry x="50" y="610" width="300" height="110" as="geometry" />
        </mxCell>

        <!-- Retry with Compensation -->
        <mxCell id="retry-box" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;strokeWidth=2;" vertex="1" parent="1">
          <mxGeometry x="380" y="570" width="320" height="160" as="geometry" />
        </mxCell>

        <mxCell id="retry-title" value="Retry Before Compensate" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;fontSize=13;fontStyle=1;fontColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="450" y="580" width="180" height="25" as="geometry" />
        </mxCell>

        <mxCell id="retry-text" value="• Transient failures should retry first&#xa;• Use exponential backoff&#xa;• Set max retry attempts&#xa;• Only compensate after retries exhausted&#xa;• Log all retry attempts for debugging" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=top;fontSize=10;fontColor=#333333;spacingLeft=10;" vertex="1" parent="1">
          <mxGeometry x="390" y="610" width="300" height="110" as="geometry" />
        </mxCell>

        <!-- Idempotency -->
        <mxCell id="idemp-box" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffe6cc;strokeColor=#d79b00;strokeWidth=2;" vertex="1" parent="1">
          <mxGeometry x="720" y="570" width="320" height="160" as="geometry" />
        </mxCell>

        <mxCell id="idemp-title" value="Idempotent Compensations" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;fontSize=13;fontStyle=1;fontColor=#d79b00;" vertex="1" parent="1">
          <mxGeometry x="790" y="580" width="180" height="25" as="geometry" />
        </mxCell>

        <mxCell id="idemp-text" value="• Compensations may run multiple times&#xa;• Must be idempotent (safe to repeat)&#xa;• Use idempotency keys&#xa;• Check current state before acting&#xa;• Example: Only refund if not already&#xa;  refunded (check refund status first)" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=top;fontSize=10;fontColor=#333333;spacingLeft=10;" vertex="1" parent="1">
          <mxGeometry x="730" y="610" width="300" height="110" as="geometry" />
        </mxCell>

        <!-- Ordering -->
        <mxCell id="order-box" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;strokeWidth=2;" vertex="1" parent="1">
          <mxGeometry x="1060" y="570" width="300" height="160" as="geometry" />
        </mxCell>

        <mxCell id="order-title" value="Compensation Order" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;fontSize=13;fontStyle=1;fontColor=#9673a6;" vertex="1" parent="1">
          <mxGeometry x="1130" y="580" width="160" height="25" as="geometry" />
        </mxCell>

        <mxCell id="order-text" value="• Reverse order of forward actions&#xa;• T1 → T2 → T3 fails&#xa;• Compensate: C3 → C2 → C1&#xa;• Maintains logical consistency&#xa;• Some compensations can run parallel&#xa;  if no dependencies exist" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=top;fontSize=10;fontColor=#333333;spacingLeft=10;" vertex="1" parent="1">
          <mxGeometry x="1070" y="610" width="280" height="110" as="geometry" />
        </mxCell>

        <!-- Best Practices -->
        <mxCell id="bp-box" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;strokeWidth=2;" vertex="1" parent="1">
          <mxGeometry x="40" y="750" width="1320" height="130" as="geometry" />
        </mxCell>

        <mxCell id="bp-title" value="Best Practices for Compensating Transactions" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;fontSize=14;fontStyle=1;fontColor=#1a1a2e;" vertex="1" parent="1">
          <mxGeometry x="500" y="760" width="400" height="25" as="geometry" />
        </mxCell>

        <mxCell id="bp-col1" value="Design:&#xa;• Design compensations alongside actions&#xa;• Keep actions small and reversible&#xa;• Avoid side effects that can't be undone" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=top;fontSize=10;fontColor=#333333;spacingLeft=10;" vertex="1" parent="1">
          <mxGeometry x="50" y="790" width="280" height="80" as="geometry" />
        </mxCell>

        <mxCell id="bp-col2" value="Implementation:&#xa;• Make all compensations idempotent&#xa;• Log all actions for audit trail&#xa;• Handle partial failures gracefully" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=top;fontSize=10;fontColor=#333333;spacingLeft=10;" vertex="1" parent="1">
          <mxGeometry x="360" y="790" width="300" height="80" as="geometry" />
        </mxCell>

        <mxCell id="bp-col3" value="Monitoring:&#xa;• Track compensation success/failure&#xa;• Alert on stuck compensations&#xa;• Have manual intervention capability" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=top;fontSize=10;fontColor=#333333;spacingLeft=10;" vertex="1" parent="1">
          <mxGeometry x="700" y="790" width="290" height="80" as="geometry" />
        </mxCell>

        <mxCell id="bp-col4" value="Testing:&#xa;• Test compensation paths thoroughly&#xa;• Inject failures to verify recovery&#xa;• Ensure data consistency after rollback" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=top;fontSize=10;fontColor=#333333;spacingLeft=10;" vertex="1" parent="1">
          <mxGeometry x="1030" y="790" width="300" height="80" as="geometry" />
        </mxCell>

      </root>
    </mxGraphModel>
  </diagram>
</mxfile>
